<!DOCTYPE html>
<meta charset="utf-8">
<style>
button {
  background-color: white;
  color: black;
  border: 2px solid #555555;
}

button:hover {
  background-color: #555555;
  color: white;
}

.flex-container {display: flex;flex-flow: row wrap;
  align-content: space-between;
  justify-content: start;}
.change-line {
	fill: none;
	stroke: black;
	stroke-width:3;
	stroke-dasharray:5, 5;
}
.bar { fill: #55c2f2;stroke-width:1;stroke:rgb(0,0,0) }
.circle { fill: #55c2f2;stroke-width:1;stroke:rgb(0,0,0) }
div.tooltip {
    position: absolute;
    text-align: center;
    max-width: 80px;
    /* height: 48px; */

    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
}
.highlight {
  stroke-width:2;
  stroke:rgb(0,0,0);
}

/*the container must be positioned relative:*/

select {
  position: relative;
  font-family: Arial;

}



/*style the arrow inside the select element:*/
select-selected:after {
  position: absolute;
  content: "";
  top: 14px;
  right: 10px;
  width: 0;
  height: 0;
  border: 6px solid transparent;
  border-color: #fff transparent transparent transparent;
}

/*point the arrow upwards when the select box is open (active):*/
select-selected.select-arrow-active:after {
  border-color: transparent transparent #fff transparent;
  top: 7px;
}

/*style the items (options), including the selected item:*/
select-items div,.select-selected {
  color: #ffffff;
  padding: 8px 16px;
  border: 1px solid transparent;
  border-color: transparent transparent rgba(0, 0, 0, 0.1) transparent;
  cursor: pointer;
  user-select: none;
}

/*style items (options):*/
select-items {
  position: absolute;
  background-color: DodgerBlue;
  top: 100%;
  left: 0;
  right: 0;
  z-index: 99;
}

/*hide the items when the select box is closed:*/
select-hide {
  display: none;
}

select-items div:hover, .same-as-selected {
  background-color: rgba(0, 0, 0, 0.1);
}
</style>
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<!-- Create a div where the graph will take place -->
<div>
<p id='status'></p>
<h3>Worst years HeatMap</h3>
Region:     <select id="select_region"></select>    <button type="button" onclick="HeatmapR()">Show Region Summary</button>
<br>
District:   <select id="select_district"></select>  <button type="button" onclick="HeatmapD()">Show District Summary</button>
<br>
<!-- <h3>Seasonal Calendar</h3>

Region: <select id="select_region2"></select> 
<br>
District: <select id="select_district2"></select> <button type="button" onclick="Season()">Show District Summary</button> -->
<!-- <button type="button" onclick="Solution()">Render</button> -->
<h3 id='title'></h3>
<div id="my_dataviz"  class="flex-container">

</div>


<div id="my_dataviz2"></div>

</div>
<br>

<!-- <h2>Complaint</h2> -->
<p id="comp"></p>


<h2 >Recommend</h2>
<form id = "exp" name="myForm">
</form>
</div>


<script>
// const url = "http://127.0.0.1:5000/";
const url = window.location.origin + '/';

let filename1 = "./db/Madagascar.csv"

d3.select("#select_satellite").selectAll("option")
    .data(['ARC','CHIRPDK','ENACTSDK','MIXEDET','MIXEDVEGg','TAMSAT3'])
    .enter()
    .append("option")
    .attr("value", function (d) { return d; })
    .text(function (d) {return d;})

function GetData(schema) {
    var x, text;
    // Get the value of the input field with id="numb"
    const data = {
        'filename' : schema.filename,
        'hiearchy': schema.hiearchy,
        'hierchy_values': schema.hierchy_values,
    };
    const other_params = {
        headers : { "content-type" : "application/json; charset=UTF-8" },
        body : JSON.stringify(data),
        method : "POST",
        mode : "cors"
    };

    return fetch(url + "api/data", other_params)
        .then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Could not reach the API: " + response.statusText);
            }
        }).then(function(data) {
            obj = JSON.parse(data)
            return obj
        })
}

function GetData2(schema) {
    var x, text;
    // Get the value of the input field with id="numb"
    const data = {
        'filename' : schema.filename,
        'hiearchy': schema.hiearchy,
        'hierchy_values': schema.hierchy_values,
    };
    const other_params = {
        headers : { "content-type" : "application/json; charset=UTF-8" },
        body : JSON.stringify(data),
        method : "POST",
        mode : "cors"
    };

    return fetch(url + "api/data2", other_params)
        .then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Could not reach the API: " + response.statusText);
            }
        }).then(function(data) {
            obj = JSON.parse(data)
            return obj
        })
}



function GetExplan(schema) {
    var x, text;
    // Get the value of the input field with id="numb"
    const data = {
        'visual' : curr_schema,
        'comp': curr_comp,
        'des': schema
    };
    const other_params = {
        headers : { "content-type" : "application/json; charset=UTF-8" },
        body : JSON.stringify(data),
        method : "POST",
        mode : "cors"
    };
    return fetch(url + "api/explan", other_params)
        .then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Could not reach the API: " + response.statusText);
            }
        }).then(function(data) {
            // obj = JSON.parse(data)
            return data
        })
}

function SendRec(schema) {
    var x, text;
    // Get the value of the input field with id="numb"
    const data = {
        'visual' : curr_schema,
        'comp': curr_comp,
        'rec': schema
    };
    const other_params = {
        headers : { "content-type" : "application/json; charset=UTF-8" },
        body : JSON.stringify(data),
        method : "POST",
        mode : "cors"
    };
    return fetch(url + "api/rec", other_params)
        .then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Could not reach the API: " + response.statusText);
            }
        }).then(function(data) {
            // obj = JSON.parse(data)
            return data
        })
}

function GetSol(schema) {
    var x, text;
    // Get the value of the input field with id="numb"
    const data = {
        'visual' : curr_schema,
        'comp': curr_comp,
        'des': schema
    };
    const other_params = {
        headers : { "content-type" : "application/json; charset=UTF-8" },
        body : JSON.stringify(data),
        method : "POST",
        mode : "cors"
    };
    return fetch(url + "api/sol", other_params)
        .then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Could not reach the API: " + response.statusText);
            }
        }).then(function(data) {
            // obj = JSON.parse(data)
            return data
        })
}


function GetHeatMap(schema) {
        var x, text;
        // Get the value of the input field with id="numb"
        const data = {
            'filename' : schema.filename,
            'hiearchy': schema.hiearchy,
            'hierchy_values': schema.hierchy_values,
            'categorical': schema.categorical,
            'numerical': schema.numerical,
            'aggragation': schema.aggragation,
            'category': schema.category
        };
        const other_params = {
            headers : { "content-type" : "application/json; charset=UTF-8" },
            body : JSON.stringify(data),
            method : "POST",
            mode : "cors"
        };
        return fetch(url + "api/heatmapdata", other_params)
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("Could not reach the API: " + response.statusText);
                }
            }).then(function(data) {
                obj = JSON.parse(data)
                console.log(obj)
                return obj
            })
    }
function HeatmapR(){
    d3.select("#my_dataviz").selectAll("svg").attr("width",500);
    let schema = {
        filename : filename1,
        hiearchy : ['Region','District','Village','_index'],
        hierchy_values : [d3.select("#select_region").property('value')],
        categorical : ['District','year'],
        numerical : ['rank'],
        aggragation : ['mean','std','count'],
        category : 'year'}
    GetHeatMap(schema)
    .then(d=>{ProcessHeatMapData(d,schema,svg,true)})
}

let village = new Set() 

function HeatmapD() {
    d3.select("#my_dataviz").selectAll("svg").attr("width",500);
        let schema = {
            filename : filename1,
            hiearchy : ['Region','District','Village','_index'],
            hierchy_values : [d3.select("#select_region").property('value') ,d3.select("#select_district").property('value') ],
            categorical : ['Village','year'],
            numerical : ['rank'],
            // aggragation : 'mean',
            aggragation : ['mean','std','count'],
            category : 'year'
        }
        GetHeatMap(schema)
        .then(d=>{
            village = new Set() 
            // replace any space or hyphen
            d.forEach((d)=>{village.add(d.Village.replace(/-|\s/g, ''))})
            // delete total
            village.delete('total')
            ProcessHeatMapData(d,schema,svg,true)
            
            })
        // svg2.selectAll("*").remove();
        svg3.selectAll("*").remove();
    }


function GetSummary(filename,hiearchy,category) {
    var x, text;
    // Get the value of the input field with id="numb"
    const data = {
        'filename': filename,
        'hiearchy': hiearchy,
        'category': category
    };
    const other_params = {
        headers : { "content-type" : "application/json; charset=UTF-8" },
        body : JSON.stringify(data),
        method : "POST",
        mode : "cors"
    };

    return fetch(url + "api/summary", other_params)
        .then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Could not reach the API: " + response.statusText);
            }
        }).then(function(data) {
            // console.log(data)
            obj = JSON.parse(data)
            // console.log(obj)
            return obj
        })
}

let curr_schema;
let curr_data
// given data and schema, render as heatmap
function ProcessHeatMapData(FilteredDataTwice,schema,svg,main = false,sate = false) {
    // console.log(sate)
        if(main){
            curr_schema = schema;
            curr_data = FilteredDataTwice;
        }
        
        svg.select("#title").remove()
        svg.append("text")
            .attr("id","title").attr("x", (width / 2))             
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")  
            .style("font-size", "16px") 
            .text(schema.filename)
            // .text(schema.filename + ":  " + schema.hierchy_values.toString())
        x_column = [...new Set(FilteredDataTwice.map(d => d[schema.categorical[0]]))].sort()
        y_column = Array.from({length: 37}, (x,i) => i+1983)
        // Build color scale
        let myColor
        if(main){
            myColor = d3.scaleLinear()
            .range(["#ae0f07","#f2d5d4"])
            .domain([1,4])
        }else{
            myColor = d3.scaleLinear()
            .range(["#cc6600","#fff3e6"])
            .domain([1,4])
        }
        if(sate){
            
            myColor = d3.scaleLinear()
            .range(["#cc6600","#fff3e6"])
            .domain([1,4])
        }
        
        let key = [1,2,3,4]
        let size = 20
        function heatmap_tooptip_mouseover2(d){tooltipdiv.style("opacity", .9);
            return tooltipdiv.html(schema.categorical[0] + ": " + d[schema.categorical[0]] +
            "<br/>" +  schema.categorical[1] + ": " +d[schema.categorical[1]] +
            "<br/>" +  schema.numerical[0] + ": " +d[schema.numerical[0]] +
            "<br/>" + "mean: " +d['mean'] +
            "<br/>" + "std: " +d['std'] +
            "<br/>" + "count: " +d['count'])}
        if(main){
            spec = {
                data: FilteredDataTwice,
                encoding:{
                    x: {range:x_column,field:schema.categorical[0]},
                    y: {range:y_column,field:schema.categorical[1]},
                    rect: {color: myColor, field: schema.numerical[0], drag: rect_drag}
                },
                legend:{
                    size:size,
                    key:key
                },
                tooltip:{
                    mouseover: heatmap_tooptip_mouseover2},
                svg:svg
            };
        }
        else{
            spec = {
                data: FilteredDataTwice,
                encoding:{
                    x: {range:x_column,field:schema.categorical[0]},
                    y: {range:y_column,field:schema.categorical[1]},
                    rect: {color: myColor, field: schema.numerical[0],drag:null}
                },
                tooltip:{
                    mouseover: heatmap_tooptip_mouseover2},
                svg:svg
            };
        }
        // console.log(spec)
        Render_heatmap(spec)
    }

let cur_summary

GetSummary(filename1, ['Region','District','Village','_index'], 'year').then(FreshDropDown)
function FreshDropDown(summary){
    cur_summary = summary
    let dropdownChangeRegion = function() {
        // change the region selection
        let dropdowndistrict = d3.select("#select_district");
                                 
        let tempobj = summary[d3.select("#select_region").property('value')]
        let district_data = tempobj[Object.keys(tempobj)[0]]
        // console.log(district_data)
        let district_element = dropdowndistrict.selectAll("option").data(district_data)
        district_element.exit().remove()
        district_element.enter().append("option").merge(district_element)
        .attr("value", function (d) { return d; })
        .text(function (d) {return d;});
        
    };
   
    // region drop down
    let dropdownregion = d3.select("#select_region").on("change", dropdownChangeRegion);
    region_data = Object.keys(summary)
    region_element = dropdownregion.selectAll("option").data(region_data)
    region_element.enter().append("option")
                .attr("value", function (d) { return d; })
                .text(function (d) {
                      return d;
                })
               ;
    region_element.exit().remove()
    dropdownChangeRegion()
}

d3.selection.prototype.moveToFront = function() {  
      return this.each(function(){
        this.parentNode.appendChild(this);
      });
    };
d3.selection.prototype.moveToBack = function() {  
        return this.each(function() { 
            var firstChild = this.parentNode.firstChild; 
            if (firstChild) { 
                this.parentNode.insertBefore(this, firstChild); 
            } 
        });
    };

let original;
var rect_drag = d3.drag()
    .on("start",function (d){original = d3.select(this).moveToFront().attr("y")}) 
    .on("drag", function (d) {
        if (d3.event.x > width || d3.event.x < 0 ||d3.event.y > height ||d3.event.y < 0 ||d.rank == null){return};
        d3.select(this).moveToFront().attr("y", d3.event.y);
        })
    .on("end",function (d){
        if(d.rank != null){
            let desired_year = inverty(d3.select(this).attr("y"));
            let previous_year = d3.select(this).data()[0]["year"];
            let previous_rank = d3.select(this).data()[0]["rank"];
            d3.select(this).attr("y", original);

            if(desired_year == d.year){
                heatmap_rect_explain(d)
            }else{
                heatmap_rect_explain(d, {"year" : desired_year,"prev_year": previous_year, "rank":previous_rank})
            }
        }
        else{
            heatmap_rect_explain(d)
        }
        d3.select(this).classed("highlight",true)
    });


var gnatt_drag = d3.drag()
    .on("start",function (d){original = d3.select(this).moveToFront().attr("y")})  
    .on("drag", function (d) {
        if (d3.event.x > width || d3.event.x < 0 ||d3.event.y > height ||d3.event.y < 0 ||d.rank == null){return};
        d3.select(this).moveToFront().attr("y", d3.event.y);
        })
    .on("end",function (d){
        if(d.rank != null){
            let desired_year = inverty(d3.select(this).attr("y"));
            d3.select(this).attr("y", original);
            if(desired_year == d.year){
                heatmap_rect_explain(d)
            }else{
                heatmap_rect_explain(d,desired_year)
            }
        }
        else{
            heatmap_rect_explain(d)
        }
        d3.select(this).moveToBack()
        d3.selectAll("#"+ d3.select(this).attr("id")).classed("highlight",true)
    });


let curr_comp;
function heatmap_rect_explain(d, schema = {}){
                curr_comp = d;
                // console.log(desired_year)
                d3.selectAll(".heatmap_rect")
                    .classed("highlight",false);
                if(curr_schema.filename == filename1){
                    d3.select("#comp")
                    .text(curr_schema.categorical[0] + ": " + d[curr_schema.categorical[0]] + ", year: " + d.year + ", rank: " + d.rank + (("year" in schema)?(", desired year: " + schema.year):"" ))
                }
                else if(curr_schema.filename == filename2){
                    d3.select("#comp")
                    .text(curr_schema.categorical[0] + ": " + d[curr_schema.categorical[0]] + ", Period: " + d.Period + ", start: " + d.start + ", end: " + d.end)
                }
                let cur_worst = []
                curr_data.forEach(element => {if(element.District == curr_comp.District && element.rank <= 10) cur_worst[element.rank] = element.year});
                if("year" in schema){
                    if(cur_worst.includes(schema.year)){
                        cur_worst[cur_worst.indexOf(schema.year)] = schema.prev_year 
                    }   
                    cur_worst[schema.rank] = schema.year
                }
                
                // console.log(cur_worst)
                schema = {
                sol: [
                    {name: 'w1', type: 'sdropdown', display: ' 1st worst: ',
                    values: Array.from({length: 36}, (x,i) => i+1983), selected: cur_worst[1]
                    },
                    {name: 'w2', type: 'sdropdown', display: ' 2nd worst: ',
                    values: Array.from({length: 36}, (x,i) => i+1983), selected: cur_worst[2]
                    },
                    {name: 'w3', type: 'sdropdown', display: ' 3rd worst: ',
                    values: Array.from({length: 36}, (x,i) => i+1983), selected: cur_worst[3]
                    },
                    {name: 'w4', type: 'sdropdown', display: ' 4th worst: ',
                    values: Array.from({length: 36}, (x,i) => i+1983), selected: cur_worst[4]
                    },
                    {name: 'name', type: 'text', display: 'Your name: '},
                    {name: 'ann', type: 'text', display: 'Side note: '},
                    {name: 'submit_button', type: 'button', display: 'Choose the Solution', onClick: "submitRec()"}
                ]
           
            };
        FormRender('#exp',schema.sol)

            }

function heatmap_point_explain(d, schema = {}){
    curr_comp = d;
    d3.selectAll(".heatmap_rect")
        .classed("highlight",false);
    if(curr_schema.filename == filename1){
        d3.select("#comp").text(curr_schema.categorical[0] + ": " + d[curr_schema.categorical[0]] + ", year: " + d.year +  ", mean: " + d.mean)
        
    }
    // else if(curr_schema.filename == filename2){
    //     d3.select("#comp")
    //     .text(curr_schema.categorical[0] + ": " + d[curr_schema.categorical[0]] + ", Period: " + d.Period + ", start: " + d.start + ", end: " + d.end)
    // }
    GetExplan(schema).then((schema)=>{FormRender("#exp",schema.explan);FormRender("#sol",schema.sol)})
    GetSol(schema).then((d)=>{
            schema = [];
            d.forEach(function (item, index) {
                console.log(item)
                schema.push({display: item[1] + " shoud have mean:" + item[2] + " , count: " + item[3]})
                svg.select(("#" + item[1] + " " + curr_comp.year).replace(/ /g,"_")).classed("highlight",true)
            });
            FormRender("#sol",schema)
        }
    )
}

// GetSummary(filename2, ['Region','District','Village','_index']).then(FreshDropDown2)
// given data and schema, render as heatmap
function ProcessGanttMapData(FilteredDataTwice,schema) {
        curr_schema = schema;
        
        let y_column = [...new Set(FilteredDataTwice.map(d => d[schema.categorical[0]]))].sort()
        let key = [...new Set(FilteredDataTwice.map(d => d.Period))].sort()
        // Build color scale
        let myColor = d3.scaleOrdinal().domain(key)
                .range(["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6", "#dd4477", "#66aa00", "#b82e2e"]);

        let size = 20
        function tooptip_mouseover(d){tooltipdiv.style("opacity", .9);
                let parseDate = d3.timeFormat("%Y-%m-%d");
                return tooltipdiv.html(schema.categorical[0] + ": "+ d[schema.categorical[0]] +
                "<br/>" +  "Period: " + d.Period +
                "<br/>" +  "Start: " + d.start +
                "<br/>" +  "End: " + d.end)}
        spec = {
            data: FilteredDataTwice,
            encoding:{
                x1: {field:"start"},
                x2: {field:"end"},
                y: {range:y_column,field:schema.categorical[0]},
                rect: {color: myColor, field: "Period",drag: gnatt_drag}
            },
            legend:{
                size:size,
                key:key
            },
            tooltip:{
                mouseover: tooptip_mouseover}
        };
        Render_gantt(spec)
    }

function FreshDropDown2(summary){
    let dropdownChangeRegion = function() {
        // FilteredData = data.filter(function(d) { return d.Region == d3.select("#select_region").property('value') });
        let dropdowndistrict = d3.select("#select_district2") ;
        let tempobj = summary[d3.select("#select_region2").property('value') ]
        let district_data = tempobj[Object.keys(tempobj)[0]]
        // console.log(district_data)
        let district_element = dropdowndistrict.selectAll("option").data(district_data)
        district_element.exit().remove()
        district_element.enter().append("option").merge(district_element)
        .attr("value", function (d) { return d; })
        .text(function (d) {return d;})
       ;
    };
    // region drop down
    let dropdownregion = d3.select("#select_region2").on("change", dropdownChangeRegion);
    region_data = Object.keys(summary)
    region_element = dropdownregion.selectAll("option").data(region_data)
    region_element.enter().append("option")
                .attr("value", function (d) { return d; })
                .text(function (d) {return d;});
    region_element.exit().remove()
    dropdownChangeRegion();
}

function Season() {
    let schema = {
            filename : filename2,
            hiearchy : ['Region','District','Village','_index'],
            hierchy_values : [d3.select("#select_region2").property('value') ,d3.select("#select_district2").property('value') ],
            categorical : ['Village']
        } 
        GetData(schema)
        .then(d=>{ProcessGanttMapData(d,schema)})
    svg2.selectAll("*").remove();
    svg3.selectAll("*").remove();
}

// This is for heatmap
// see which explanation is selected and updates the solution
function Solution () {
  let selected = d3.select('input[name="explan"]:checked').node().value
  let form = d3.select("#sol");
  if (selected == 0){
      let schema = {
                sol: [
                    {name: 'country', type: 'dropdown', display: 'Correct the rank of village: ',
                    values: ['1', '2', '3','4','5','6','7','8','9','10']
                    },
                    {name: 'submit_button', type: 'button', display: 'Choose the Solution'}
                ]
            };
        FormRender('#sol',schema.sol)
  }
  else if (selected == 1){
      let schema = {
                sol: [
                    {name: 'country', type: 'text', display: 'Correct the name of village: '},
                    {name: 'submit_button', type: 'button', display: 'Choose the Solution'}
                ]
            };
        FormRender('#sol',schema.sol)
  }
  else if (selected == 2){
    DrillDown();
    FormRender("#exp",[])
    FormRender("#sol",[])
  }
  else if (selected == 3){
      let schema = {
                sol: [
                    {name: 'country', type: 'dropdown', display: 'Add the rank of village: ',
                    values: ['1', '2', '3','4','5','6','7','8','9','10']},
                    {name: 'submit_button', type: 'button', display: 'Choose the Solution'}
                ]
            };
        FormRender('#sol',schema.sol)
  }
  else if (selected == 4){
      let schema = {
                sol: [
                    {name: 'country', type: 'dropdowns', display: 'Correct the start value: ',
                    values: [month_name ,Array.from({length:31},(v,k)=>k+1)]},
                    {name: 'submit_button', type: 'button', display: 'Choose the Solution'}
                ]
            };
        FormRender('#sol',schema.sol)
  }
  else if (selected == 5){
      let schema = {
                sol: [
                    {name: 'country', type: 'dropdowns', display: 'Correct the end value: ',
                     values: [month_name ,Array.from({length:31},(v,k)=>k+1)]},
                    {name: 'submit_button', type: 'button', display: 'Choose the Solution'}
                ]
            };
        FormRender('#sol',schema.sol)
  }
  else if (selected == 6){
        FormRender('#sol',[])
  }
  else if (selected == 7){
        FormRender('#sol',[])
  }

}

function DrillDown(){
    if(curr_schema.hierchy_values.length < curr_schema.hiearchy.length - 1){
        let next_h = curr_schema.hiearchy[curr_schema.hierchy_values.length] 
        let next_h_value = curr_comp[next_h]
        let next_next_h = curr_schema.hiearchy[curr_schema.hierchy_values.length + 1] 
        let schema = curr_schema
        schema.hierchy_values.push(next_h_value)
        schema.categorical[0] = next_next_h
        if(schema.filename == filename1){
            GetHeatMap(schema).then(d=>{ProcessHeatMapData(d,schema)})
        }else if(schema.filename == filename2){
            GetData(schema).then(d=>{ProcessGanttMapData(d,schema)})
        }
    } 

}

// add form according to schema
function FormRender (id, schema={}) {
    d3.select(id).selectAll("p").remove()
    let explanations = d3.select(id).selectAll("p").data(schema)
    explanations.enter().append("p").merge(explanations)
            .each(function(d){
                let self = d3.select(this);
                let label = self.append("label")
                    .text(d.display)

                if(d.type == 'text'){
                    let input = self.append("input").attr("type",d.type).attr("name",d.name).attr("id", d.name)
                }
                


                if(d.type == 'radio'){
                    let input = self.append("input")
                     .attr("type",d.type).attr("name",d.name).attr("value",d.value).property('checked',d.checked)
                }
                if(d.type == 'dropdown'){
                let select = self.append("select")
                        .attr("name", "country")
                        .selectAll("option")
                        .data(d.values)
                        .enter()
                        .append("option")
                        .text(function(d) { return d; });
                }
                if(d.type == 'sdropdown'){
                let selected = d.selected
                let select = self.append("select")
                        .attr("id", d.name)
                        .selectAll("option")
                        .data(d.values)
                        .enter()
                        .append("option")
                        .text(function(d) { return d; })
                        .property("selected", function(d) {
                            return d === selected;
                        });
                }
                if(d.type == 'dropdowns'){
                let select = self.selectAll('select')
                        .data(d.values)
                        .enter()
                        .append("select")
                        .attr("id", function (d, i) {
                           return "o" + i;
                        })
                        .selectAll("option")
                        .data( function (d, i) {
                           return d;
                        })
                        .enter()
                        .append("option")
                        .text(function(d) { return d; });
                }
                if(d.type == 'button'){
                    // console.log(d)
                    let select = self.append("button").attr("type",d.type).attr('onclick',d.onClick).text('Submit')
                }
            });
}

function submitRec(){
    result = {"w1":d3.select("#w1").property("value"),"w2":d3.select("#w2").property("value"),
    "w3":d3.select("#w3").property("value"),"w4":d3.select("#w4").property("value"),
    "name":d3.select("#name").property("value"),"ann":d3.select("#ann").property("value")
    }
    SendRec(result).then(()=>{
        schema = {
                sol: [
                    {display: 'Success'
                    }]
           
            };
        FormRender('#exp',schema.sol)
        })
    
}

// set the dimsensions and margins of the graph
let margin = {top: 50, right: 200, bottom: 100, left: 60},
    width = 500 - margin.left - margin.right,
    height = 650 - margin.top - margin.bottom;

// append the svg object to the body of the page
let svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");
let svg2 = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");       
let svg3 = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");       
let tooltipdiv = d3.select("#my_dataviz").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0)
  .style("left", "20px")
  .style("top", "44px");

function Render_gantt(spec){
    width = 1000 - margin.left - margin.right;
    d3.select("#my_dataviz").select("svg").attr("width", width + margin.left + margin.right)
    // console.log(spec)
    if("legend" in spec){
        // Add one dot in the legend for each name.
        let dots =  svg.selectAll("#mydots")
            .data(spec.legend.key)
        dots.exit().remove()
        dots.enter()
            .append("rect").merge(dots)
            .attr("x", width+margin.left)
            .attr("y", function(d,i){ return 100 + i*(spec.legend.size+5)})
            .attr("width", spec.legend.size)
            .attr("height", spec.legend.size)
            .style("fill", function(d){ return spec.encoding.rect.color(d)})
            .attr("id","mydots")

        // Add one dot in the legend for each name.
        let labels =  svg.selectAll("#mylabels").data(spec.legend.key)
        labels.exit().remove()
        labels.enter()
            .append("text").merge(labels)
            .attr("x", width+margin.left+30)
            .attr("y", function(d,i){ return 100 + i*(spec.legend.size+5) + (spec.legend.size/2)})
            .text(function(d){ return d})
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .attr("id","mylabels")
    }

    // Build y scales and axis:
    let y = d3.scaleBand()
        .range([height, 0])
        .domain(spec.encoding.y.range)
        .padding(0.01);
    d3.select("#y_axis").remove()
    svg.append("g")
        .attr("id","y_axis")
        .call(d3.axisLeft(y));

    // Build X scales and axis:
    let x = d3.scaleLinear()
    .range([ 0, width ])
    .domain([1,365])

    month = ["1-1","2-1","3-1","4-1","5-1","6-1","7-1","8-1","9-1","10-1","11-1","12-1"]
    
    ticks = month.map(get_day_of_year)
    month_map = {}
    ticks.forEach((key, i) => month_map[key] = month_name[i]);
    d3.select("#x_axis").remove()
    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .attr("id","x_axis")
        .call(d3.axisBottom(x).tickValues(ticks).tickFormat(d => month_map[d]))


    let rectangle = svg.selectAll(".heatmap_rect").data(spec.data)
    rectangle.exit().remove()

    let round_data = []
    rectangle.enter()
        .append("rect").merge(rectangle)
        .attr("x", function(d) { return x(get_day_of_year(d[spec.encoding.x1.field]))})
        .attr("y", function(d) { return y(d[spec.encoding.y.field])})
        
        .attr("width", function(d, i) {
            if (x(get_day_of_year(d[spec.encoding.x2.field])) - x(get_day_of_year(d[spec.encoding.x1.field])) < 0){
                let newobj = {}
                newobj[spec.encoding.x2.field] = d[spec.encoding.x2.field]
                newobj[spec.encoding.x1.field] = d[spec.encoding.x1.field]
                newobj[spec.encoding.y.field] = d[spec.encoding.y.field]
                newobj[spec.encoding.rect.field] = d[spec.encoding.rect.field]
                newobj["id"]= "p" + i
                round_data.push(newobj)
                // console.log(i, x(365), x(get_day_of_year(d[spec.encoding.x1.field])))
                return x(365) - x(get_day_of_year(d[spec.encoding.x1.field]))
            }
            // console.log(i, x(get_day_of_year(d[spec.encoding.x2.field])) - x(get_day_of_year(d[spec.encoding.x1.field])))
            return x(get_day_of_year(d[spec.encoding.x2.field])) - x(get_day_of_year(d[spec.encoding.x1.field]))
                })
        .classed("heatmap_rect",true)
        .attr("id",function(d, i){return "p" +  i})        
        .attr("height", y.bandwidth() )
        .style("fill", function(d) { return spec.encoding.rect.color(d[spec.encoding.rect.field])})
        .on("mouseover",spec.tooltip.mouseover)
        .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
        .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})
        .style("opacity", 0.5)
        .call(spec.encoding.rect.drag);

    rectangle = svg.selectAll(".heatmap_rect").data(round_data)
    rectangle.enter()
        .append("rect").merge(rectangle)
        .attr("x", function(d) { return x(1)})
        .attr("y", function(d) { return y(d[spec.encoding.y.field])})
        
        .attr("width", function(d, i) {
                return x(get_day_of_year(d[spec.encoding.x2.field])) - x(1) 
            })
        .classed("heatmap_rect",true)
        .attr("id",function(d, i){return d["id"]})        
        .attr("height", y.bandwidth() )
        .style("fill", function(d) { return spec.encoding.rect.color(d[spec.encoding.rect.field])})
        .on("mouseover",spec.tooltip.mouseover)
        .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
        .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})
        .style("opacity", 0.5)
        .call(spec.encoding.rect.drag);
}

let inverty;

let invertx;
function Render_heatmap(spec){
    s = spec.svg
    
    width = spec.encoding.x.range.length*20;
    d3.select("#my_dataviz").selectAll("svg").attr("width", width + margin.left + margin.right);
    if("legend" in spec){
        // Add one dot in the legend for each name.
        let dots =  s.selectAll("#mydots")
            .data(spec.legend.key)
        dots.exit().remove()
        dots.enter()
            .append("rect").merge(dots)
            .attr("x", width+margin.left)
            .attr("y", function(d,i){ return 100 + i*(spec.legend.size+5)})
            .attr("width", spec.legend.size)
            .attr("height", spec.legend.size)
            .style("fill", function(d){
                return spec.encoding.rect.color(d)})
            .attr("id","mydots")

        // Add one dot in the legend for each name.
        let labels =  s.selectAll("#mylabels").data(spec.legend.key)
        labels.exit().remove()
        labels.enter()
            .append("text").merge(labels)
            .attr("x", width+margin.left+30)
            .attr("y", function(d,i){ return 100 + i*(spec.legend.size+5) + (spec.legend.size/2)})
            .text(function(d){ return d})
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .attr("id","mylabels")
    }

    // Build y scales and axis:
    let y = d3.scaleBand()
        .range([height, 0])
        .domain(spec.encoding.y.range)
        .padding(0.01);

    inverty = function (mouse_y){
        var eachBand = y.step();
        var index = Math.round((mouse_y / eachBand));
        return y.domain()[y.domain().length-index - 1];
    } 

    s.select("#y_axis").remove()
    s.append("g")
        .attr("id","y_axis")
        .call(d3.axisLeft(y));

    // Build X scales and axis:
    let x = d3.scaleBand()
    .range([ 0, width ])
    .domain(spec.encoding.x.range)
    .padding(0.01);

    s.select("#x_axis").remove()
    s.append("g")
        .attr("transform", "translate(0," + height + ")")
        .attr("id","x_axis")
        // .attr('transform', 'rotate(45 -10 10)')
        .call(d3.axisBottom(x))
        .selectAll("text")  
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");
        


    let rectangle = s.selectAll(".heatmap_rect").data(spec.data)
    rectangle.exit().remove()
    rectangle.enter()
        .append("rect").merge(rectangle)
        .attr("x", function(d) { return x(d[spec.encoding.x.field]) })
        .attr("y", function(d) { return y(d[spec.encoding.y.field]) })
        .classed("heatmap_rect",true)
        .attr("id",function(d) { return (d[spec.encoding.x.field] + " " + d[spec.encoding.y.field]).replace(/ /g,"_") })
        .attr("width", x.bandwidth() )
        .attr("height", y.bandwidth() )
        .style("opacity", 1 )
        .classed("highlight",false)
        .style("fill", function(d) { 
            if (d[spec.encoding.rect.field] == 0)
                return "#FFFFFF"
            else
                return spec.encoding.rect.color(d[spec.encoding.rect.field])})
        .on("mouseover",spec.tooltip.mouseover)
        .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
        .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})
        .on("click", spec.encoding.rect.click)
        .call(spec.encoding.rect.drag);
}

function Render_mean(spec, s = svg){
    
    width = 300

    // Build y scales and axis:
    let y = d3.scalePoint()
        .range([height, 0])
        .domain(spec.encoding.y.range)
        .padding(0.5);


    s.select("#y_axis").remove()
    s.append("g")
        .attr("id","y_axis")
        .call(d3.axisLeft(y));

    // Build X scales and axis:
    let x = d3.scaleLinear()
    .domain([-1, 11])
    .range([ 0, width ]);

    invertx = function (mouse_y){
        let r = Math.round(x.invert(mouse_y))
        if(r < 1){
            r = 1
        }else if(r > 10){
            r = 10
        }
        return r;
    } 

    s.select("#x_axis").remove()
    s.append("g")
        .attr("transform", "translate(0," + height + ")")
        .attr("id","x_axis")
        .call(d3.axisBottom(x))
        .selectAll("text")  
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");
    data = spec.data.filter(function (d){
        return d[spec.encoding.x.field] === "total";
    });
    let line = s.selectAll(".line").remove()
    s.selectAll(".line").data(data).enter()
        .append('path')
        .attr('d',  function(d) {return d3.line()([[x(d["mean"]-d["std"]),y(d["year"])], [x(d["mean"]+d["std"]),y(d["year"])]]) })
        .attr('stroke', 'blue')
        .attr('stroke-width', 2)
        .classed("dot",false)
        .classed("line",true)
        .on("mouseover",spec.tooltip.mouseover)
        .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
        .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})

    let dot = s.selectAll(".dot").remove()
    s.selectAll(".dot").data(data).enter()
        .append("circle")
        .attr("cx", function(d) { return x(d["mean"]) })
        .attr("cy", function(d) { return y(d["year"]) })
        .attr("r", 3)
        .classed("dot",true)
        .classed("line",false)
        .attr('fill', function(d){if(d["mean"] === null){return 'none'} return "black"})
        .on("mouseover",spec.tooltip.mouseover)
        .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
        .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})
        .call(spec.encoding.rect.drag);


    
}

function Render_barmean(spec, s = svg){
    
    width = 300
    if("legend" in spec){
        // Add one dot in the legend for each name.
        let dots =  s.selectAll("#mydots")
            .data(spec.legend.key)
        dots.exit().remove()
        dots.enter()
            .append("rect").merge(dots)
            .attr("x", width+margin.left)
            .attr("y", function(d,i){ return 100 + i*(spec.legend.size+5)})
            .attr("width", spec.legend.size)
            .attr("height", spec.legend.size)
            .style("fill", function(d){
                return spec.encoding.rect.color(d)})
            .attr("id","mydots")

        // Add one dot in the legend for each name.
        let labels =  s.selectAll("#mylabels").data(spec.legend.key)
        labels.exit().remove()
        labels.enter()
            .append("text").merge(labels)
            .attr("x", width+margin.left+30)
            .attr("y", function(d,i){ return 100 + i*(spec.legend.size+5) + (spec.legend.size/2)})
            .text(function(d){ return d})
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .attr("id","mylabels")
    }
    // Build y scales and axis:
    let y = d3.scaleBand()
        .range([height, 0])
        .domain(spec.encoding.y.range)
        .padding(0.01);

    inverty = function (mouse_y){
        var eachBand = y.step();
        var index = Math.round((mouse_y / eachBand));
        return y.domain()[y.domain().length-index - 1];
    } 

    s.select("#y_axis").remove()
    s.append("g")
        .attr("id","y_axis")
        .call(d3.axisLeft(y));

    data = spec.data.filter(function (d){
        return d[spec.encoding.x.field] === "total";
    });
    mcount = 0;
    data.forEach(d => mcount = Math.max(mcount, d["count"]));
    // Build X scales and axis:
    let x = d3.scaleLinear()
    .domain([0, mcount])
    .range([ 0, width ]);

    s.select("#x_axis").remove()
    s.append("g")
        .attr("transform", "translate(0," + height + ")")
        .attr("id","x_axis")
        .call(d3.axisBottom(x))
        .selectAll("text")  
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");


    s.selectAll(".bar").remove()
    s.selectAll(".bar").data(data).enter()
        .append("rect")
        .attr("x", 0)
        .attr("y", function(d) { return y(d["year"]) })
        .classed("bar",true)
        .attr("width", function(d) { return x(d["count"]) } )
        .attr("height", y.bandwidth() )
        .style("opacity", 1 )
        .style("fill", function(d) { 
            if (d[spec.encoding.rect.field] == null)
                return "#FFFFFF"
            else
                return spec.encoding.rect.color(d[spec.encoding.rect.field])})
        .on("mouseover",spec.tooltip.mouseover)
        .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
        .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})
    
}


let month_name = ["jan", "feb", "march", "april", "may", "june", "july", "aug", "sep", "oct", "nov", "dec"]

function get_day_of_year(str_date){
    let month = parseInt(str_date.split("-")[0])
    let day = parseInt(str_date.split("-")[1])
    let day_of_year = 0;
    let ary_months = [
        0,
        31, //jan
        28, //feb(non leap)
        31, //march
        30, //april
        31, //may
        30, //june
        31, //july
        31, //aug
        30, //sep
        31, //oct
        30, //nov   
        31  //dec
        ];
    for(var i=1; i < month; i++){
        day_of_year += ary_months[i];
    }
    day_of_year += day
    return day_of_year;
}



</script>
