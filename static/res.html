<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Complaint Driven Drill Down</title>
    <style>
        html {
            font-family: sans-serif;
            -webkit-text-size-adjust: 100%;
        }
        body {
            width: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
            background-color: #e2e9f3;
            font-size: 12px;
            line-height: 18px;
        }
        .abs-100 {
            left: 0;
            right: 0;
        }
        .hflex, .vflex {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-direction: normal;
            position: relative;
        }
        .vflex {
            -webkit-box-orient: vertical;
            -ms-flex-direction: column;
            flex-direction: column;    
        }
        .hflex {
            -webkit-box-align: stretch;
            -ms-flex-align: stretch;
            align-items: stretch;
            -webkit-box-orient: horizontal;
            -ms-flex-direction: row;
            flex-direction: row;
        }
        .full-height {
            height: 100%;
        }
        .full-width {
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            max-width: initial;
        }
        .flex-root {
            overflow: auto;
        }
        .no-shrink {
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }
        .card {
            margin: 3px 3px 0 0;
            padding: 8px;
            background: #fff;
            border-style: none;
        }
        .top-card {
            background-color: #fcfdfe;
        }
        .no-right-margin {
            margin-right: 0 !important;
        }
        .no-top-margin {
            margin-top: 0 !important;
        }
        .pane {
            padding: 0;
            position: relative;
        }
        .controls {
            margin-left: 33px;
            margin-top: 7px;
        }
        .grow-1 {
            -webkit-box-flex: 1;
            -ms-flex-positive: 1;
            flex-grow: 1;
        }
        .main-panel {
            min-height: 250px;
            height: 450px;
            -webkit-box-flex: 1.5;
            -ms-flex-positive: 1.5;
            flex-grow: 1.5;
        }
        .pane.data-pane, .pane.encoding-pane {
            width: 235px;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }
        .pane.data-pane {
            width: 200px;
        }
        .pane {
            padding: 0;
            position: relative;
        }
        .noselect, .shelf .shelf-label, h1, h2, h3, h4 {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }

        .abs-100 {
            left: 0;
            right: 0;
        }
        .abs-100, .abs-h100 {
            position: absolute;
            top: 0;
            bottom: 0;
        }
        .data-card {
            background-color: #242430;
        }
        .pane.vis-pane {
            -webkit-box-flex: 1;
            -ms-flex-positive: 1;
            flex-grow: 1;
            margin-top: 1px;
        }
        .vis-pane-container {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
        }
        .scroll-y {
            overflow-y: scroll;
        }
        .abs-100 {
            left: 0;
            right: 0;
        }
        .abs-100, .abs-h100 {
            position: absolute;
            top: 0;
            bottom: 0;
        }
        .alternatives-pane {
            margin-top: 20px;
            background: rgba(255,255,255,.4);
        }
        .vl-plot-group-list-container {
            margin-bottom: 20px;
        }

        .vis-list-header {
            padding-top: 6px;
            background-color: transparent;
        }
        .vis-list {
            -ms-flex-line-pack: start;
            align-content: flex-start;
        }
        .flex-wrap {
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
        }
        .vl-plot-group.wrapped-vl-plot-group {
            overflow-x: hidden;
            max-height: 650px;
            max-width: 500px;
            -webkit-box-flex: 1;
            -ms-flex-positive: 1;
            flex-grow: 1;
            padding-right: 11px;
            padding-bottom: 11px;
        }
        .field-info.enumerated-channel, .field-info.pill.enumerated-channel, .field-info.selected.enumerated-channel, .field-info.unselected.enumerated-channel {
            border: 1px dashed rgba(15,123,133,.2);
            opacity: .8;
        }
        #bookmark-list .bookmark-list-util, .field-info {
            display: inline-block;
            margin-right: 8px;
        }

        .vl-plot-group-header {
            margin-bottom: 5px;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
        }
        .no-shrink {
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        .vl-plot-group.wrapped-vl-plot-group .vl-plot {
            min-height: 100px;
        }
        .vl-plot {
            min-width: 180px;
            overflow: hidden;
            text-align: center;
        }
        .flex-grow-1 {
            -webkit-box-flex: 1;
            -ms-flex-positive: 1;
            flex-grow: 1;
        }

        .vl-plot.scroll {
            overflow: auto;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            max-width: 100px;
            /* height: 48px; */

            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        .highlight {
            stroke-width:2 !important; 
            stroke:rgb(0,0,0) !important;
        }
        .comp {
            width: 180px;
            text-align: left;
            padding-top: 5px;
	        padding-left: 20px;
        }
        .shelf {
            border-radius: 3px;
            background-color: #dda7f8;
            width: 100%;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            height: 22px;
        }
        
        .collapsible:hover, .active {
            background-color: #9115e3;
            color: white;
        }
        .shelf .shelf-label {
            display: block;
            width: 45px;
            margin: 0 .2rem;
            line-height: 22px;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }
        .submit{
            background-color: #d5d5d5;
        }
        .submit:hover {
            background-color: #5f5f5f;
            color: white;
        }
        .noselect, .shelf .shelf-label, h1, h2, h3, h4 {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }
        .shelf-group {
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-bottom: 4px;
            font-size: 11px;
        }
        .shelf .field-drop{
            width: 60%;
        }
        .shelf .field-drop .placeholder {
            display: block;
            width: 100%;
            padding: 0 .5em;
            border: 1px solid rgba(77,77,77,.1);
            background-color: #fff;
            line-height: 20px;
            border-radius: 3px;
            text-overflow: ellipsis;
            font-weight: 400;
            color: #000;
        }
        .btn {
            border: 2px solid black;
            background-color: white;
            color: black;
            padding: 14px 28px;
            font-size: 16px;
            cursor: pointer;
        }
        .content {
            padding: 0 18px;
            background-color: #f1f1f1;
        }
        .hidden{
            display: none;
            overflow: hidden;
        }
        .right {
            float: right;
        }
        button, input, optgroup, select, textarea {
            color: inherit;
            font: inherit;
            margin: 0;
        }
        button, select {
            text-transform: none;
        }
        select.markselect {
            background: #f8f8f8;
            color: #333;
            border: #888 1px solid;
            display: inline-block;
        }
        select.markselect.auto {
            background: #e3f9fd;
            color: #5798a5;
            border: #9bc4cc 1px solid;
        }
        
    </style>
</head>
<body>
    <div class="abs-100 ng-scope">
        <div class="flex-root vflex full-width full-height ng-scope">
            <div class="full-width no-shrink">
                <div class="card top-card no-right-margin no-top-margin">
                    <div class="hflex">
                        <div class="pane">
                            <div class="controls">
                                <h1>Complaint Driven Drill Down</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="hflex full-width main-panel grow-1">
                <div class="pane data-pane noselect">
                    <div class="card no-top-margin data-card abs-100" style="color: white;">
                        <h2>Guide</h2>
                        To view details, hover over or click on the rectangle in the heatmap. <br>
                        Value = 11 - rank. The higher the value is, the more severe<br>
                        After you click a rectangle in the heatmap, the scatterplot and barchart will show up. <br>

                        To make complaints, click on the aggregation function in the detail pane, enter your desired value, and click on "complain" <br>
                        For any problem, contact Zachary Huang zh2408 AT columbia.edu.
                    </div>
                </div>

                <div class="pane vis-pane">
                    <div class="vis-pane-container abs-100 scroll-y">
                        <div class="alternatives-pane card no-top-margin ng-scope">
                            <div class="alternatives-header"><h2>Country</h2></div>
                            <div class="alternatives-content ng-scope">
                                <div class="vl-plot-group-list-container ng-scope ng-isolate-scope">
                                    <div class="vis-list-header" ng-show="listTitle &amp;&amp; !hideListTitle">
                                        <h3 class="ng-binding">Ethiopia</h3>
                                    </div>
                                    <div class="vis-list hflex flex-wrap">
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    HeatMap: Mean
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "c_1" width="383" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Scatterplot: Mean and Std
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "c_2" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Bar Chart: Mean and Count
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "c_3" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Detail
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                  
                                                    <div id = "c_4" class="comp card" >
                                                        
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>

                        <div id="RegionStart" class="alternatives-pane card ng-scope hidden">
                            <div class="alternatives-header"><h2>Region</h2></div>
                            <div class="alternatives-content ng-scope">
                                <div class="vl-plot-group-list-container ng-scope ng-isolate-scope">
                                    <div class="vis-list-header" ng-show="listTitle &amp;&amp; !hideListTitle">
                                        <h3 id="RegionName" class="ng-binding">name</h3>
                                    </div>
                                    <div class="vis-list hflex flex-wrap">
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    HeatMap: Mean
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "r_1" width="383" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                

                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    HeatMap: Mean (satellite)
                                                </span>
                                                <div class="right">
                                                    <select id="RegionSate" class="markselect">

                                                    </select>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "r_5" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Scatterplot: Mean and Std
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "r_2" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Bar Chart: Mean and Count
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "r_3" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Detail
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                  
                                                    <div id = "r_4" class="comp card" >
                                                        
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="DistrictStart" class="alternatives-pane card ng-scope hidden">
                            <div class="alternatives-header"><h2>District</h2></div>
                            <div class="alternatives-content ng-scope">
                                <div class="vl-plot-group-list-container ng-scope ng-isolate-scope">
                                    <div class="vis-list-header" ng-show="listTitle &amp;&amp; !hideListTitle">
                                        <h3 id="DistrictName" class="ng-binding">name</h3>
                                    </div>
                                    <div class="vis-list hflex flex-wrap">
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    HeatMap: Mean
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "d_1" width="383" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                

                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    HeatMap: Mean (satellite)
                                                </span>
                                                <div class="right">
                                                    <select id="DistrictSate" class="markselect">

                                                    </select>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "d_5" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Scatterplot: Mean and Std
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "d_2" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Bar Chart: Mean and Count
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "d_3" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Detail
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                  
                                                    <div id = "d_4" class="comp card" >
                                                        
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="VillageStart" class="alternatives-pane card ng-scope hidden">
                            <div class="alternatives-header"><h2>Village</h2></div>
                            <div class="alternatives-content ng-scope">
                                <div class="vl-plot-group-list-container ng-scope ng-isolate-scope">
                                    <div class="vis-list-header" ng-show="listTitle &amp;&amp; !hideListTitle">
                                        <h3 id="VillageName" class="ng-binding">name</h3>
                                    </div>
                                    <div class="vis-list hflex flex-wrap">
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    HeatMap: Mean
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "v_1" width="383" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Scatterplot: Mean and Std
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "v_2" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Bar Chart: Mean and Count
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                    <svg id = "v_3" width="300" height="500">
                                                    </svg>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="wrapped-vl-plot-group card vl-plot-group vflex ng-scope ng-isolate-scope">
                                            <div  class="vl-plot-group-header no-shrink">
                                                <span class="field-info ng-scope ng-isolate-scope enumerated-channel">
                                                    Detail
                                                </span>
                                            </div>
                                            <div class="flex-grow-1 vl-plot ng-isolate-scope scroll">
                                                <div class="vega" style="position: relative;">
                                                  
                                                    <div id = "v_4" class="comp card" >
                                                        
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div> 
    </div>

</body>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>

// url to this page (and infer server address)
const url = window.location.origin + '/';
let filename = "./db/heatmap_data_lineage.csv"

// margin.right_short is for no lengend
let margin = {top: 10, right: 100, bottom: 100, left: 60, right_short: 20},
    // width = 500 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

// set up collapsible
// https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_collapsible
// let coll = document.getElementsByClassName("collapsible");

// function collapsibleToggle(){
//     console.log(this)
//     this.classList.toggle("active");
//     let content = this.nextElementSibling;
//     if (content.style.display === "block") {
//       content.style.display = "none";
//     } else {
//       content.style.display = "block";
//     }
// }


// get data for heatmap
// example schema
// let schema = {
//         filename : filename1,
//         hiearchy : ['Region','District','Village','_index'],
//         hierchy_values : [d3.select("#select_region").property('value')],
//         categorical : ['District','year'],
//         numerical : ['rank'],
//         aggragation : ['mean','std','count'],
//         category : 'year'}
// to call this function, use promises
// GetHeatMap(schema).then(d=>{console.log(d)})
function GetHeatMap(schema) {
        var x, text;
        // Get the value of the input field with id="numb"
        const data = {
            'filename' : schema.filename,
            'hiearchy': schema.hiearchy,
            'hierchy_values': schema.hierchy_values,
            'categorical': schema.categorical,
            'numerical': schema.numerical,
            'aggragation': schema.aggragation,
            'category': schema.category
        };
        const other_params = {
            headers : { "content-type" : "application/json; charset=UTF-8" },
            body : JSON.stringify(data),
            method : "POST",
            mode : "cors"
        };
        return fetch(url + "api/heatmapdata", other_params)
            .then(function(response) {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("Could not reach the API: " + response.statusText);
                }
            }).then(function(data) {
                obj = JSON.parse(data)
                console.log(obj)
                // we don't need rank here
                obj.forEach(element=> delete element["rank"])
                ; 
                return obj
            })
    }

// special method for village sate because only village attribute
function GetData2(schema) {
    var x, text;
    // Get the value of the input field with id="numb"
    const data = {
        'filename' : schema.filename,
        'hiearchy': schema.hiearchy,
        'hierchy_values': schema.hierchy_values,
    };
    const other_params = {
        headers : { "content-type" : "application/json; charset=UTF-8" },
        body : JSON.stringify(data),
        method : "POST",
        mode : "cors"
    };

    return fetch(url + "api/data2", other_params)
        .then(function(response) {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error("Could not reach the API: " + response.statusText);
            }
        }).then(function(data) {
            obj = JSON.parse(data)
            return obj
        })
}

let tooltipdiv = d3.select("body").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0)
  .style("left", "20px")
  .style("top", "44px");




class DataStorage{
    constructor() {
        this.data = {}
        this.schema = {}
        this.sate = {}
    }
    putData(level, data){
        this.data[level] = data
    }
    putSate(sate, data){
        this.sate[sate] = data
    }
    putSchema(level, data){
        this.schema[level] = data
    }
    getData(level){
        return this.data[level]
    }
    getSchema(level){
        return this.schema[level]
    }
    getData(level, field, value){
        return this.data[level].filter((d)=> d[field] === value);
    }
    getSate(sate){
        return this.sate[sate]
    }
}

let LocalData = new DataStorage()

class Visualization{
    // option for vis
    // and link to other vis
    constructor(svg_id, options) {
        this.svg = d3.select(svg_id)   
        this.options = options
        this.explanable = true
        
    }
    registerLinks(links){
        this.links = links
    }
    plot(){

    }
    highlight(){

    }
    propogate(schema){
        // highlight other vis linked
        this.links.forEach(vis => vis.highlight(schema, this.explanable));
    }
    propogateClear(){
        // highlight other vis linked
        this.links.forEach(vis => vis.clear());
    }
    clear(){

    }
}

function heatmap_tooptip_mouseover(d){
    tooltipdiv.style("opacity", .9);
    return tooltipdiv.html(objToStr(d))
}

function objToStr(d){
    let str = ""
    for (let [key, value] of Object.entries(d)) {
        if(isFloat(value)){
            str += key + ": " + value.toFixed(2) + "<br/>";
        }else{
            str += key + ": " + value + "<br/>";
        } 
    }
    return str
}

// options needs to specify the color 
// specified by an array of two element [start, end]
// {
//     color: ["#cc6600","#fff3e6"],
// }
class HeatMap extends Visualization {
    // plot HeatMap given the schema
    plot(schema) {
        this.propogateClear()
        this.schema = schema
        this.process(LocalData.getData(schema.categorical[0]))
    }
    process(data){
        
        // get all the names as x
        let x_column = [...new Set(data.map(d => d[this.schema.categorical[0]]))].sort()
        
        // generate all the years (hard coded)
        let y_column = Array.from({length: 36}, (x,i) => i+1983)

        // generate color according to option
        let Color = d3.scaleLinear()
            .range(this.options.color)
            .domain([0,10])

        //for the legend
        let key = [0,1,2,3,4,5,6,7,8,9,10]
        let size = 15


        let spec = {
            data: data,
            encoding:{
                x: {range:x_column,field: this.schema.categorical[0]},
                y: {range:y_column,field: this.schema.categorical[1]},
                rect: {color: Color, field: this.schema.aggragation [0]}
            },
            legend:{
                    size:size,
                    key:key
                },
            tooltip:{
                mouseover: heatmap_tooptip_mouseover},
            svg: this.svg
        };
        this.spec = spec
        this.render(this.spec)
    }
    clear(){
        this.svg.select("g").remove()
    }
    render(spec){
        let width = spec.encoding.x.range.length*15;
        this.clear()

        let s = spec.svg.attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")"); 

        if("legend" in spec){
            // Add one dot in the legend for each name.
            let dots =  s.selectAll("#mydots")
                .data(spec.legend.key)
            dots.exit().remove()
            dots.enter()
                .append("rect").merge(dots)
                .attr("x", width+20)
                .attr("y", function(d,i){ return 100 + i*(spec.legend.size+5)})
                .attr("width", spec.legend.size)
                .attr("height", spec.legend.size)
                .style("fill", function(d){
                    return spec.encoding.rect.color(d)})
                .attr("id","mydots")

            // Add one dot in the legend for each name.
            let labels =  s.selectAll("#mylabels").data(spec.legend.key)
            labels.exit().remove()
            labels.enter()
                .append("text").merge(labels)
                .attr("x", width+40)
                .attr("y", function(d,i){ return 100 + i*(spec.legend.size+5) + (spec.legend.size/2)})
                .text(function(d){ return d})
                .attr("text-anchor", "left")
                .style("alignment-baseline", "middle")
                .attr("id","mylabels")
        }

        // Build y scales and axis:
        let y = d3.scaleBand()
            .range([height, 0])
            .domain(spec.encoding.y.range)
            .padding(0.01);

        s.select("#y_axis").remove()
        s.append("g")
            .attr("id","y_axis")
            .call(d3.axisLeft(y));

        // Build X scales and axis:
        let x = d3.scaleBand()
        .range([ 0, width ])
        .domain(spec.encoding.x.range)
        .padding(0.01);

        s.select("#x_axis").remove()
        s.append("g")
            .attr("transform", "translate(0," + height + ")")
            .attr("id","x_axis")
            // .attr('transform', 'rotate(45 -10 10)')
            .call(d3.axisBottom(x))
            .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-65)");

        // this in d3 refers to html element
        let callerClass = this;
        let rectangle = s.selectAll(".heatmap_rect").data(spec.data)
        rectangle.exit().remove()
        rectangle.enter()
            .append("rect").merge(rectangle)
            .attr("x", function(d) { return x(d[spec.encoding.x.field]) })
            .attr("y", function(d) { return y(d[spec.encoding.y.field]) })
            .classed("heatmap_rect",true)
            // no space allowed in the id
            .attr("id",function(d) { return ("i" + d[spec.encoding.x.field] + " " + d[spec.encoding.y.field]).replace(/ /g,"_") })
            .attr("width", x.bandwidth() )
            .attr("height", y.bandwidth() )
            .style("opacity", 1 )
            .classed("highlight",false)
            .style("fill", function(d) { 
                if (d[spec.encoding.rect.field] == 0)
                    return "#FFFFFF"
                else
                    return spec.encoding.rect.color(d[spec.encoding.rect.field])})
            .on("mouseover",spec.tooltip.mouseover)
            .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
            .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})
            .on("click", function(d){
                callerClass.highlight(d, callerClass.explanable)
                callerClass.propogate(d)
            })
    }
    highlight(schema){
        this.cancelHighlight()
        this.svg.select("#" + ("i" + schema[this.spec.encoding.x.field] + " " + schema[this.spec.encoding.y.field]).replace(/ /g,"_"))
                .moveToFront()
                .classed("highlight",true) 
    }
    cancelHighlight(){
        // console.log(this.svg)
        this.svg.selectAll(".heatmap_rect").classed("highlight",false);
    } 
}

class RegionSatelliteHeatMap extends HeatMap{
    constructor(svg_id, options){
        super(svg_id, options)
        this.explanable = false
    }
    // when plot, need to first get satellite data
    // when put sate, first filter values
    plot(schema) {
        // deep copy schema since we are going to change it
        // can pass nothing when changing satellite
        if(schema){
            this.schema = JSON.parse(JSON.stringify(schema))
        }
        
        let level = "Region"
        let sate = d3.select("#" + level +"Sate").property("value")
        this.schema.filename = SateToFile[sate]

        GetHeatMap(this.schema).then(d=>{
            // filter out 
            d = d.filter((e)=> m2.spec.encoding.x.range.includes(e[nextLevel(level)]))
            
            this.process(d)
        })

    }

}

class DistrictSatelliteHeatMap extends HeatMap{
    constructor(svg_id, options){
        super(svg_id, options)
        this.explanable = false
    }
    // when plot, need to first get satellite data
    // when put sate, first filter values
    plot(schema) {
        // can pass nothing when changing satellite
        if(schema){
            this.schema = schema
        }
        
        let level = "District"
        let sate = d3.select("#" + level +"Sate").property("value")
        // hard link to m3
        let Sateschema = {
                filename : SateToFile[sate],
                hiearchy : ['Village'],
                categorical : ['Village','Year'],
                hierchy_values : m3.spec.encoding.x.range}

        GetData2(Sateschema).then((d)=>{
            // console.log(d)
                d.forEach(e => {
                    e['year'] = e['Year']
                    delete e['Year']
  
                })
                
                // filter out our of bound years
                this.process(d.filter((d) => 
                    m3.spec.encoding.y.range.includes(d['year'])))

            })

    }
    process(data){
        
        // get all the names as x
        let x_column = [...new Set(data.map(d => d[this.schema.categorical[0]]))].sort()
        
        // generate all the years (hard coded)
        let y_column = Array.from({length: 36}, (x,i) => i+1983)

        
        let minRank = data[0].value;
        let maxRank = data[0].value;
       
        data.forEach(d => {
            maxRank = Math.max(maxRank, d["value"])
            minRank = Math.min(minRank, d["value"])
        });   
     
        // generate color according to option
        let Color = d3.scaleLinear()
            .range(this.options.color)
            .domain([minRank,maxRank])
            console.log(Color)
        //for the legend
        let key = range(minRank,  maxRank, 10) 
        let size = 15


        let spec = {
            data: data,
            encoding:{
                x: {range:x_column,field: this.schema.categorical[0]},
                y: {range:y_column,field: this.schema.categorical[1]},
                rect: {color: Color, field: "value"}
            },
            legend:{
                    size:size,
                    key:key
                },
            tooltip:{
                mouseover: heatmap_tooptip_mouseover},
            svg: this.svg
        };
        this.spec = spec
        this.render(this.spec)
    }
    
}

class ScatterPlot extends Visualization {
    // plot HeatMap given the schema
    plot(schema, value) {
        this.schema = schema
        this.value
        this.process(LocalData.getData(schema.categorical[0],schema.categorical[0],value))
    }
    
    process(data){   
        // generate all the years (hard coded)
        let y_column = Array.from({length: 36}, (x,i) => i+1983)

        //for the legend
        let key = [1,2,3,4,5,6,7,8,9,10]
        let size = 15

        let spec = {
            data: data,
            encoding:{
                y: {range:y_column,field: this.schema.categorical[1]},
            },
            tooltip:{
                mouseover: heatmap_tooptip_mouseover},
            svg: this.svg
        };
        this.spec = spec
        this.render(this.spec)
    }

    clear(){
        this.svg.select("g").remove()
    }

    render(spec){
        let width = 200;
        this.clear()
        let s = spec.svg.attr("width", width + margin.left + margin.right_short)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")"); 

        // Build y scales and axis:
        let y = d3.scaleLinear()
            .range([height, 0])
            // hard code this part for year we need some padding
            .domain([1982.5,2018.5])
            // .domain(spec.encoding.y.range)

        s.select("#y_axis").remove()
        s.append("g")
            .attr("id","y_axis")
            .call(d3.axisLeft(y).ticks(36).tickFormat(d3.format("d")));

        // Build X scales and axis:
        let x = d3.scaleLinear()
        .domain([-1, 11])
        .range([ 0, width ]);

        s.select("#x_axis").remove()
        s.append("g")
            .attr("transform", "translate(0," + height + ")")
            .attr("id","x_axis")
            // .attr('transform', 'rotate(45 -10 10)')
            .call(d3.axisBottom(x))
            .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-65)");

        // http://bl.ocks.org/dustinlarimer/5888271
        // marker
        let marks = [ { name: 'stub', path: 'M 0,0 m -1,-5 L 1,-5 L 1,5 L -1,5 Z', viewbox: '-1 -5 2 10' }]
        let defs = s.append('svg:defs')
        defs.selectAll('marker')
            .data(marks)
            .enter()
            .append('svg:marker')
            .attr('id', function(d){ return 'marker_' + d.name})
            .attr('markerHeight', 5)
            .attr('markerWidth', 5)
            .attr('markerUnits', 'strokeWidth')
            .attr('orient', 'auto')
            .attr('refX', 0)
            .attr('refY', 0)
            .attr('viewBox', function(d){ return d.viewbox })
            .append('svg:path')
                .attr('d', function(d){ return d.path })

        
        let callerClass = this;
        let line = s.selectAll(".line").remove()
        s.selectAll(".line").data(spec.data).enter()
            .append('path')
            .attr('d',  function(d) {return d3.line()([[x(d["mean"]-d["std"]),y(d["year"])], [x(d["mean"]+d["std"]),y(d["year"])]]) })
            .attr('stroke', 'black')
            .attr('stroke-width', 1)
            .classed("dot",false)
            .classed("line",true)
            .attr('marker-start', 'url(#marker_stub)')
            .attr('marker-end', 'url(#marker_stub)')
            .attr("id", function(d){ return "a" + d["year"]})
            .on("mouseover",spec.tooltip.mouseover)
            .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
            .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})
            .on("click", function(d){
                callerClass.highlight(d)
                callerClass.propogate(d)
            })

        let dot = s.selectAll(".dot").remove()
        s.selectAll(".dot").data(spec.data).enter()
            .append("circle")
            .attr("cx", function(d) { return x(d["mean"]) })
            .attr("cy", function(d) { return y(d["year"]) })
            .attr("r", 3)
            // need class because we want to first know what to remove
            .classed("dot",true)
            .classed("line",false)
            .attr('fill', function(d){if(d["mean"] === null){return 'none'} return "grey"})
            // id can't start with num
            .attr("id", function(d){ return "a" + d["year"]})
            .on("mouseover",spec.tooltip.mouseover)
            .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
            .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})
            .on("click", function(d){
                callerClass.highlight(d)
                callerClass.propogate(d)
            })
    }
    // line and dot are identified by year
    highlight(schema){
        // console.log(schema)
        if(this.schema == null){
            this.schema = LocalData.getSchema(getLevel(schema))
            this.plot(this.schema, schema[this.schema.categorical[0]])
        }
        else if(schema[this.schema.categorical[0]] != this.value){
            this.plot(this.schema, schema[this.schema.categorical[0]])
        }

        this.cancelHighlight()
        this.svg.selectAll("#" + "a" + schema["year"] )
                .moveToFront()
                .classed("highlight",true)
    }

    cancelHighlight(){
        this.svg.selectAll(".dot").classed("highlight",false);
        this.svg.selectAll(".line").classed("highlight",false);
    } 
}

class BarChart extends Visualization {
    // plot HeatMap given the schema
    plot(schema, value) {
        this.schema = schema
        this.process(LocalData.getData(schema.categorical[0],schema.categorical[0],value))
    }
    
    process(data){   
        // generate all the years (hard coded)
        let y_column = Array.from({length: 36}, (x,i) => i+1983)

        //for the legend
        let key = [1,2,3,4,5,6,7,8,9,10]
        let size = 15
        
        // generate color according to option
        let Color = d3.scaleLinear()
            .range(this.options.color)
            .domain([0,10])

        let spec = {
            data: data,
            encoding:{
                y: {range:y_column,field: this.schema.categorical[1]},
                rect: {color: Color, field: this.schema.aggragation [0]}
            },
            tooltip:{
                mouseover: heatmap_tooptip_mouseover},
            svg: this.svg
        };
        this.spec = spec
        this.render(this.spec)
    }
    clear(){
        this.svg.select("g").remove()
    }
    render(spec){
        let width = 200;
        this.clear()
        let s = spec.svg.attr("width", width + margin.left + margin.right_short)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")"); 

        // Build y scales and axis:
        let y = d3.scaleBand()
            .range([height, 0])
            .domain(spec.encoding.y.range)
            .padding(0.01);

        s.select("#y_axis").remove()
        s.append("g")
            .attr("id","y_axis")
            .call(d3.axisLeft(y));
        
        let maxCount = 0;
        spec.data.forEach(d => maxCount = Math.max(maxCount, d["count"]));    

        // Build X scales and axis:
        let x = d3.scaleLinear()
        .domain([0, maxCount])
        .range([ 0, width ]);

        s.select("#x_axis").remove()
        s.append("g")
            .attr("transform", "translate(0," + height + ")")
            .attr("id","x_axis")
            // .attr('transform', 'rotate(45 -10 10)')
            .call(d3.axisBottom(x))
            .selectAll("text")  
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-65)");

        
        let callerClass = this;
        s.selectAll(".bar").remove()
        s.selectAll(".bar").data(spec.data).enter()
            .append("rect")
            .attr("x", 0)
            .attr("y", function(d) { return y(d["year"]) })
            .classed("bar",true)
            .attr("id", function(d){ return "a" + d["year"]})
            .attr("width", function(d) { return x(d["count"]) } )
            .attr("height", y.bandwidth() )
            .style("opacity", 1 )
            .style("fill", function(d) { 
                if (d[spec.encoding.rect.field] == null)
                    return "#FFFFFF"
                else
                    return spec.encoding.rect.color(d[spec.encoding.rect.field])})
            .style("stroke-width", 0.5)  
            // stroke with max color value
            .style("stroke", spec.encoding.rect.color(10))      
            .on("mouseover",spec.tooltip.mouseover)
            .on("mousemove", function(){return tooltipdiv.style("top", (event.pageY)+"px").style("left",(event.pageX)+"px");})
            .on("mouseout", function(){return tooltipdiv.style("opacity", 0);})
            .on("click", function(d){
                callerClass.highlight(d)
                callerClass.propogate(d)
            })
    }
    // bar are identified by year
    highlight(schema){

        if(this.schema == null){
            this.schema = LocalData.getSchema(getLevel(schema))
            this.plot(this.schema, schema[this.schema.categorical[0]])
        }
        else if(schema[this.schema.categorical[0]] != this.value){
            this.plot(this.schema, schema[this.schema.categorical[0]])
        }
        this.cancelHighlight()
        this.svg.select("#" + "a" + schema["year"] )
                .moveToFront()
                .classed("highlight",true)
    }
    
    cancelHighlight(){
        this.svg.selectAll(".bar").classed("highlight",false);
    } 
}

class Explanation{
    constructor(svg_id, links) {
        this.svg = d3.select(svg_id) 
        this.links = links
    }
    highlight(schema, explanable){
        this.clear()
        this.addDetail(schema, explanable)
        // this.svg.append("p").merge(explanations)
        // this.
    }
    clear(){
        this.svg.selectAll("div").remove()
    }
    addDetail(data, explanable){
        // console.log(d)
        let agg = ['mean','std','count']
        let s  = this.svg
        // can also use data enter
        // however some logics are hard to write like staggering shelf and content
        Object.entries(data).forEach(function(attribute) {
            // console.log(attribute)

            let shelf_group = s.append("div")
                                .classed('shelf-group',true)
                                
            let shelf = shelf_group.append("div")
                                .classed('shelf',true) 

            if(agg.includes(attribute[0]) && explanable){
                let content = shelf_group.append("div")
                                      .classed('content',true)
                                      .classed('hidden',true)
                                      .text("helloworld")

                shelf.classed("collapsible",true)
                    .on("click", function(){
                        if(shelf.classed('active')){
                            shelf.classed('active',false)
                            content.style("display", "none")
                        }else{
                            shelf.classed('active',true)
                            content.style("display", "block")
                        }
                    })
            }
            shelf.append("div")
                 .classed('shelf-label',true) 
                 .text(attribute[0])
            
            shelf.append("div")
                 .classed('field-drop',true)
                 .append("span")
                 .classed('placeholder',true)
                 .text(attribute[1])
        })

        let callerClass = this;
        
        // drill down to next level
        if(Object.entries(data)[0][0] != '_index'){
            s.append("div")
                .classed('shelf-group',true)
                .style("width", "40%")
                .append("div")
                .classed('shelf',true)
                .classed('submit',true)
                .append("span")
                .style("margin","auto")
                .text("Drill down")
                .on('click', function() {
                    callerClass.drillDown(Object.entries(data)[0])})
        }
    }

    drillDown(nextLevelData){
        let curSchema = LocalData.getSchema(nextLevelData[0])
       
        // deep copy
        let nextSchema = JSON.parse(JSON.stringify(curSchema));
        nextSchema.categorical[0] = nextLevel(nextLevelData[0])
        nextSchema.hierchy_values.push(nextLevelData[1])

        GetHeatMap(nextSchema).then(d=>{
            LocalData.putData(nextSchema.categorical[0],d)
            LocalData.putSchema(nextSchema.categorical[0], nextSchema)
            this.links.forEach(v => v.plot( nextSchema))
            d3.select("#" + nextLevelData[0] + "Name").text(nextLevelData[1])

            let elmnt = document.getElementById(nextLevelData[0] + "Start");
            
            showLevel(nextLevelData[0])
            hideBelow(nextLevelData[0])
            elmnt.scrollIntoView({behavior: 'smooth'});
        })

    }
}

let s4 = new ScatterPlot("#v_2",{})
let b4 = new BarChart("#v_3", {color:["#ffffff","#ff0097"]})
let e4 = new Explanation("#v_4",[])
let m4 = new HeatMap("#v_1",{color:["#ffffff","#ff0097"]})
s4.registerLinks([b4,e4,m4])
b4.registerLinks([e4,s4,m4])
m4.registerLinks([s4,b4,e4])

let s3 = new ScatterPlot("#d_2",{})
let b3 = new BarChart("#d_3", {color:["#ffffff","#ff0097"]})
let e3 = new Explanation("#d_4",[m4])
let m3 = new HeatMap("#d_1",{color:["#ffffff","#ff0097"]})
let sate3 = new DistrictSatelliteHeatMap("#d_5",{color:["#ffffff","#0056da"]})
s3.registerLinks([b3,e3,m3,sate3])
b3.registerLinks([e3,s3,m3,sate3])
m3.registerLinks([s3,b3,e3,sate3])
sate3.registerLinks([s3,b3,m3,e3])

let s2 = new ScatterPlot("#r_2",{})
let b2 = new BarChart("#r_3", {color:["#ffffff","#ff0097"]})
let e2 = new Explanation("#r_4",[m3, sate3])
let m2 = new HeatMap("#r_1",{color:["#ffffff","#ff0097"]})
let sate2 = new RegionSatelliteHeatMap("#r_5",{color:["#ffffff","#ff0097"]})
s2.registerLinks([b2,e2,m2,sate2])
b2.registerLinks([e2,s2,m2,sate2])
m2.registerLinks([s2,b2,e2,sate2])
sate2.registerLinks([s2,b2,m2,e2])


let s1 = new ScatterPlot("#c_2",{})
let b1 = new BarChart("#c_3", {color:["#ffffff","#ff0097"]})
let e1 = new Explanation("#c_4",[m2, sate2])
let m1 = new HeatMap("#c_1",{color:["#ffffff","#ff0097"]})
s1.registerLinks([b1,e1,m1])
b1.registerLinks([e1,s1,m1])
m1.registerLinks([s1,b1,e1])


let filename1 = "./db/heatmap_data_lineage.csv"
let filename2 = "./db/intitiate_cleaned2.csv"
let filename3 = "./db/CHIRPS.csv"
let filename4 = "./db/enactsr.csv"
let filename5 = "./db/0-SubregionYearRanksEarlyARC.csv"
let filename6 = "./db/0-SubregionYearRanksLateARC.csv"
let filename7 = "./db/0-SubregionYearRanksEarlyCHIRPDK.csv"
let filename8 = "./db/0-SubregionYearRanksLateCHIRPDK.csv"
let filename9 = "./db/0-SubregionYearRanksEarlyENACTSDK.csv"
let filename10 = "./db/0-SubregionYearRanksLateENACTSDK.csv"
let filename11 = "./db/0-SubregionYearRanksEarlyMIXEDET.csv"
let filename12 = "./db/0-SubregionYearRanksLateMIXEDET.csv"
let filename13 = "./db/0-SubregionYearRanksEarlyMIXEDVEGg.csv"
let filename14 = "./db/0-SubregionYearRanksLateMIXEDVEGg.csv"
let filename15 = "./db/0-SubregionYearRanksEarlyTAMSAT3.csv"
let filename16 = "./db/0-SubregionYearRanksLateTAMSAT3.csv"


let SateToFile ={
    CHIRPS: filename3,
    ENACTSR: filename4,
    EarlyARC: filename5,
    LateARC: filename6,
    EarlyCHIRPDK: filename7,
    LateCHIRPDK: filename8,
    EarlyENACT: filename9,
    LateENACT: filename10,
    EarlyMIXEDET: filename11,
    LateMIXEDET: filename12,
    EarlyMIXEDVEGg: filename13,
    LateMIXEDVEGg: filename14,
    EarlyTAMSAT3: filename15,
    LateTAMSAT3: filename16,
}

let RegionSate = ["CHIRPS","ENACTSR"]
let DistrictSate = ["EarlyARC","LateARC","EarlyCHIRPDK","LateCHIRPDK",
        "EarlyENACT","LateENACT","EarlyMIXEDET","LateMIXEDET",
        "EarlyMIXEDVEGg","LateMIXEDVEGg","EarlyTAMSAT3","LateTAMSAT3"]


d3.select("#RegionSate")
      .selectAll('option')
      .data(RegionSate)
      .enter()
      .append('option')
      .text(function (d) { return d; })
      .attr("value", function (d) { return d; }) 
      
d3.select("#RegionSate").on("change", function() {
       sate2.plot()
    })

d3.select("#DistrictSate")
      .selectAll('option')
      .data(DistrictSate)
      .enter()
      .append('option')
      .text(function (d) { return d; })
      .attr("value", function (d) { return d; }) 

d3.select("#DistrictSate").on("change", function() {
       sate3.plot()
    })

let schemaInitial = {
        filename : filename1,
        hiearchy : ['Region','District','Village','_index'],
        hierchy_values : [],
        categorical : ['Region','year'],
        numerical : ['rank'],
        aggragation : ['mean','std','count'],
        category : 'year'}
// let schemaInitial = {
//         filename : filename3,
//         hiearchy : ['Region','District','Village','_index'],
//         hierchy_values : ['Amhara'],
//         categorical : ['District','year'],
//         numerical : ['rank'],
//         aggragation : ['mean','std','count'],
//         category : 'year'}


GetHeatMap(schemaInitial).then(d=>{
    LocalData.putData(schemaInitial.categorical[0],d)
    LocalData.putSchema(schemaInitial.categorical[0],schemaInitial)
    m1.plot(schemaInitial)

})



function range(start, stop, count) {
    step = (stop - start)/count
    if (typeof stop == 'undefined') {
        // one param defined
        stop = start;
        start = 0;
    }

    if (typeof count == 'undefined') {
        step = 1;
    }

    if ((step > 0 && start >= stop) || (step < 0 && start <= stop)) {
        return [];
    }

    var result = [];
    for (var i = start; result.length < count; i += step) {
        result.push(i.toFixed(2))
    }

    return result;
};



// For element overlap
d3.selection.prototype.moveToFront = function() {  
      return this.each(function(){
            this.parentNode.appendChild(this);
      });
    };

d3.selection.prototype.moveToBack = function() {  
        return this.each(function() { 
            var firstChild = this.parentNode.firstChild; 
            if (firstChild) { 
                this.parentNode.insertBefore(this, firstChild); 
            } 
        });
    };

    
// from data, return the level
// which is assumed to be the first key
function getLevel(schema){
    return Object.keys(schema)[0]
}

// hardcode
// ['Region','District','Village','_index']
function nextLevel(curLevel){
    if(curLevel === 'Region') return 'District'
    else if(curLevel === 'District') return 'Village'
    else if(curLevel === 'Village') return '_index'
}

function isFloat(n){
    return Number(n) === n && n % 1 !== 0;
}

function hideBelow(level){
    switch(level) {
        case 'Region':
            hideLevel('District')
        case 'District':
            hideLevel('Village')
        } 
}

function hideLevel(level){
    d3.select("#" + level + "Start").style("display", "none").style("overflow","hidden")
}

function showLevel(level){
    d3.select("#" + level + "Start").style("display", "block").style("overflow","visible")
}
</script>